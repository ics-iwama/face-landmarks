import*as i from"https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();let P=["hige","ribbon","rabbit","cat02","cat03","bear01"],S={},T=document.querySelectorAll(".button"),H=document.querySelectorAll(".position-controllerButton"),f="rabbit";const b=640,w=480,I=document.querySelector("#canvas"),d=document.querySelector("#video");let c,D,l,F,p=0,h=0,y,E,u;const L={hige:{scale:30,basePoint:164,xFix:5,yFix:-20},rabbit:{scale:280,basePoint:1,xFix:10,yFix:-30},ribbon:{scale:70,basePoint:0,xFix:5,yFix:-5},cat02:{scale:180,basePoint:1,xFix:5,yFix:-20},cat03:{scale:190,basePoint:1,xFix:0,yFix:0},bear01:{scale:180,basePoint:1,xFix:0,yFix:0}};function k(){u=new i.WebGLRenderer({canvas:I,alpha:!0}),u.setPixelRatio(window.devicePixelRatio),u.setSize(b,w),u.setClearColor(0,0),y=new i.Scene;const o=45;E=new i.PerspectiveCamera(o,b/w,1,1e3),E.position.set(0,0,680),z()}function A(){T.forEach(o=>{o.addEventListener("click",e=>{p=0,h=0,f=e.target.dataset.deco||e.target.parentElement.dataset.deco,W()})}),H.forEach(o=>{o.addEventListener("click",e=>{const t=e.target.dataset.position||e.target.parentElement.dataset.position;t==="top"?h+=5:t==="bottom"?h-=5:t==="right"?p-=5:t==="left"&&(p+=5)})})}function B(){let o=0;P.forEach(e=>{const t=new Image;t.onload=()=>{S[e]=t.width/t.height,o++,o===P.length&&(k(),q())},t.src=`face-landmarks/images/${e}.png`})}function z(){const o=L[f],e=S[f],t=new i.PlaneGeometry(e,1),n=new i.TextureLoader().load(`face-landmarks/images/${f}.png`,function(s){s.colorSpace=i.SRGBColorSpace}),a=new i.MeshBasicMaterial({map:n,side:i.DoubleSide,transparent:!0});c=new i.Mesh(t,a),c.scale.set(o.scale,o.scale,0),y.add(c)}function W(){c&&(y.remove(c),c.geometry.dispose(),c.material.dispose(),c=null),z()}function G(){if(l&&l.length>0){const o=U();c.quaternion.copy(o);const e=L[f],t=R(l[0].keypoints),r=t[e.basePoint],n=new i.Vector3(r.x+p+e.xFix,r.y+h+e.yFix,r.z-150),a=t[1],s=t[127],m=t[356],V=s.x-m.x,C=s.y-m.y,g=Math.atan2(C,V),N=Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2)),O=Math.sqrt(Math.pow(a.x-m.x,2)+Math.pow(a.y-m.y,2)),x=(N+O)/200;c.scale.set(e.scale*x,-e.scale*x,0);const v=e.scale*x;n.y+=v/2;const M=v/2*Math.sin(g);n.x+=M,n.y-=M*Math.sin(g),c.position.copy(n),c.rotation.z=g}}function q(){u.render(y,E),$(),G(),requestAnimationFrame(q)}function U(){if(l&&l.length>0){const o=R(l[0].keypoints),e=o[1],t=o[279],r=o[49],n={x:(t.x+r.x)/2,y:(t.y+r.y)/2,z:(t.z+r.z)/2},a={x:n.x,y:n.y-10,z:n.z};F=new i.Vector3(e.x,e.y,e.z).sub(new i.Vector3(a.x,a.y,a.z)).normalize();const s=new i.Quaternion;return s.setFromUnitVectors(new i.Vector3(0,0,1),F),s}}async function j(){const o={video:{width:b,height:w,facingMode:"user"},audio:!1};try{const e=await navigator.mediaDevices.getUserMedia(o);return d.srcObject=e,new Promise(t=>{d.onloadedmetadata=()=>{t(d)}})}catch(e){console.error("Error accessing webcam: ",e),alert("カメラのアクセスに失敗しました。カメラのアクセス権限を確認してください。")}}async function X(){const o=faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,e={runtime:"mediapipe",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"};D=await faceLandmarksDetection.createDetector(o,e)}async function $(){const o={flipHorizontal:!1};l=await D.estimateFaces(d,o)}function R(o){return o.map(t=>({x:t.x-d.videoWidth/2,y:-t.y+d.videoHeight/2,z:(t.z/100*-1+1)*100}))}async function K(){A(),B(),await j(),await X()}K();
