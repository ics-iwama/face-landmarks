import*as a from"https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))c(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&c(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function c(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();let z={},f="rabbit";const D=["hige","ribbon","rabbit","cat02","cat03","bear01"],I=document.querySelectorAll(".button"),B=document.querySelectorAll(".position-controllerButton"),W=document.querySelector("#canvas"),l=document.querySelector("#video"),v=640,F=480;let i,q,d,L,h=0,x=0,b,P,u;const C={hige:{scale:30,basePoint:164,xFix:5,yFix:-20},rabbit:{scale:280,basePoint:1,xFix:10,yFix:-30},ribbon:{scale:70,basePoint:0,xFix:5,yFix:-5},cat02:{scale:210,basePoint:1,xFix:5,yFix:-20},cat03:{scale:190,basePoint:1,xFix:0,yFix:0},bear01:{scale:180,basePoint:1,xFix:0,yFix:0}};function j(){u=new a.WebGLRenderer({canvas:W,alpha:!0}),u.setPixelRatio(window.devicePixelRatio),u.setSize(v,F),u.setClearColor(0,0),b=new a.Scene;const o=45;P=new a.PerspectiveCamera(o,v/F,1,1e3),P.position.set(0,0,680),O()}function G(){I.forEach(o=>{o.addEventListener("click",e=>{h=0,x=0,f=e.target.dataset.deco||e.target.parentElement.dataset.deco,X()})}),B.forEach(o=>{o.addEventListener("click",e=>{const t=e.target.dataset.position||e.target.parentElement.dataset.position;t==="top"?x+=5:t==="bottom"?x-=5:t==="right"?h-=5:t==="left"&&(h+=5)})})}function U(){let o=0;D.forEach(e=>{const t=new Image;t.onload=()=>{z[e]=t.width/t.height,o++,o===D.length&&(j(),R())},t.src=`face-landmarks/images/${e}.png`})}function O(){const o=C[f],e=z[f],t=new a.PlaneGeometry(e,1),n=new a.TextureLoader().load(`face-landmarks/images/${f}.png`,function(r){r.colorSpace=a.SRGBColorSpace}),s=new a.MeshBasicMaterial({map:n,side:a.DoubleSide,transparent:!0});i=new a.Mesh(t,s),i.scale.set(o.scale,o.scale,0),b.add(i)}function X(){i&&(b.remove(i),i.geometry.dispose(),i.material.dispose(),i=null),O()}function $(){if(!d||d.length===0)return;const o=K();i.quaternion.copy(o);const e=C[f],t=T(d[0].keypoints),c=t[e.basePoint],n=navigator.userAgent.toLowerCase(),s=/iphone|ipad|ipod|android/.test(n),r=l.srcObject.getTracks()[0].getSettings().facingMode==="user",V=s&&r?200:120,m=new a.Vector3(c.x+h+e.xFix,c.y+x+e.yFix,c.z-V),p=t[1],g=t[127],y=t[356],N=g.x-y.x,A=g.y-y.y,w=Math.atan2(A,N),H=Math.hypot(p.x-g.x,p.y-g.y),k=Math.hypot(p.x-y.x,p.y-y.y),E=(H+k)/200;i.scale.set(e.scale*E,-e.scale*E,0);const S=e.scale*E;m.y+=S/2;const M=S/2*Math.sin(w);m.x+=M,m.y-=M*Math.sin(w),i.position.copy(m),i.rotation.z=w}function R(){u.render(b,P),_(),$(),requestAnimationFrame(R)}function K(){if(!d||d.length===0)return;const o=T(d[0].keypoints),e=o[1],t=o[279],c=o[49],n={x:(t.x+c.x)/2,y:(t.y+c.y)/2,z:(t.z+c.z)/2},s={x:n.x,y:n.y-10,z:n.z};L=new a.Vector3(e.x,e.y,e.z).sub(new a.Vector3(s.x,s.y,s.z)).normalize();const r=new a.Quaternion;return r.setFromUnitVectors(new a.Vector3(0,0,1),L),r}async function Q(){const o={video:{width:v,height:F,facingMode:"user"},audio:!1};try{const e=await navigator.mediaDevices.getUserMedia(o);return l.srcObject=e,new Promise(t=>{l.onloadedmetadata=()=>{t(l)}})}catch(e){console.error("Error accessing webcam: ",e),alert("カメラのアクセスに失敗しました。カメラのアクセス権限を確認してください。")}}async function Y(){const o=faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,e={runtime:"mediapipe",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"};q=await faceLandmarksDetection.createDetector(o,e)}async function _(){const o={flipHorizontal:!1};d=await q.estimateFaces(l,o)}function T(o){return o.map(t=>({x:t.x-l.videoWidth/2,y:-t.y+l.videoHeight/2,z:(t.z/100*-1+1)*100}))}async function J(){G(),U(),await Q(),await Y()}J();
