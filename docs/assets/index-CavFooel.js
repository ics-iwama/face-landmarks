import*as i from"https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();let F=["hige","ribbon","rabbit","cat02","cat03","bear01"],S={},T=document.querySelectorAll(".button"),H=document.querySelectorAll(".position-controllerButton"),u="rabbit";const h=960,g=540,I=document.querySelector("#canvas"),m=document.querySelector("#video");let c,D,l,M,p=0,y=0,x,E,d;const L={hige:{scale:30,basePoint:164,xFix:5,yFix:-20},rabbit:{scale:280,basePoint:1,xFix:10,yFix:-30},ribbon:{scale:70,basePoint:0,xFix:5,yFix:-5},cat02:{scale:180,basePoint:1,xFix:5,yFix:-20},cat03:{scale:190,basePoint:1,xFix:0,yFix:0},bear01:{scale:180,basePoint:1,xFix:0,yFix:0}};function k(){d=new i.WebGLRenderer({canvas:I,alpha:!0}),d.setPixelRatio(window.devicePixelRatio),d.setSize(h,g),d.setClearColor(0,0),x=new i.Scene;const o=45;E=new i.PerspectiveCamera(o,h/g,1,1e3),E.position.set(0,0,680),z()}function A(){T.forEach(o=>{o.addEventListener("click",e=>{p=0,y=0,u=e.target.dataset.deco||e.target.parentElement.dataset.deco,G()})}),H.forEach(o=>{o.addEventListener("click",e=>{const t=e.target.dataset.position||e.target.parentElement.dataset.position;t==="top"?y+=5:t==="bottom"?y-=5:t==="right"?p-=5:t==="left"&&(p+=5)})})}function B(){let o=0;F.forEach(e=>{const t=new Image;t.onload=()=>{S[e]=t.width/t.height,o++,o===F.length&&(k(),q())},t.src=`/face-landmarks/images/${e}.png`})}function z(){const o=L[u],e=S[u],t=new i.PlaneGeometry(e,1),n=new i.TextureLoader().load(`/face-landmarks/images/${u}.png`,function(s){s.colorSpace=i.SRGBColorSpace}),a=new i.MeshBasicMaterial({map:n,side:i.DoubleSide,transparent:!0});c=new i.Mesh(t,a),c.scale.set(o.scale,o.scale,0),x.add(c)}function G(){c&&(x.remove(c),c.geometry.dispose(),c.material.dispose(),c=null),z()}function U(){if(l&&l.length>0){const o=W();c.quaternion.copy(o);const e=L[u],t=R(l[0].keypoints),r=t[e.basePoint],n=new i.Vector3(r.x+p+e.xFix,r.y+y+e.yFix,r.z-150),a=t[1],s=t[127],f=t[356],V=s.x-f.x,C=s.y-f.y,b=Math.atan2(C,V),N=Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2)),O=Math.sqrt(Math.pow(a.x-f.x,2)+Math.pow(a.y-f.y,2)),w=(N+O)/200;c.scale.set(e.scale*w,-e.scale*w,0);const P=e.scale*w;n.y+=P/2;const v=P/2*Math.sin(b);n.x+=v,n.y-=v*Math.sin(b),c.position.copy(n),c.rotation.z=b}}function q(){d.render(x,E),$(),U(),requestAnimationFrame(q)}function W(){if(l&&l.length>0){const o=R(l[0].keypoints),e=o[1],t=o[279],r=o[49],n={x:(t.x+r.x)/2,y:(t.y+r.y)/2,z:(t.z+r.z)/2},a={x:n.x,y:n.y-10,z:n.z};M=new i.Vector3(e.x,e.y,e.z).sub(new i.Vector3(a.x,a.y,a.z)).normalize();const s=new i.Quaternion;return s.setFromUnitVectors(new i.Vector3(0,0,1),M),s}}async function j(){const o=await navigator.mediaDevices.getUserMedia({audio:!1,video:{width:h,height:g}});return m.srcObject=o,new Promise(e=>{m.onloadedmetadata=()=>{e(m)}})}async function X(){const o=faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,e={runtime:"mediapipe",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"};D=await faceLandmarksDetection.createDetector(o,e)}async function $(){const o={flipHorizontal:!1};l=await D.estimateFaces(m,o)}function R(o){return o.map(t=>({x:t.x-h/2,y:-t.y+g/2,z:(t.z/100*-1+1)*100}))}async function K(){A(),B(),await j(),await X()}K();
